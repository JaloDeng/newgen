<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.newgen.mapper.ActivityMapper" >

	<!-- Result Map-->
	<resultMap id="BaseResultMap" type="com.newgen.bean.Activity" >
		<result column="id" property="id" />
		<result column="status" property="status" />
		<result column="title" property="title" />
		<result column="summary" property="summary" />
		<result column="sponsorId" property="sponsorId" />
		<result column="homePath" property="homePath" />
		<result column="serialNumber" property="serialNumber" />
		<result column="editor" property="editor" />
		<result column="fromTime" property="fromTime" />
		<result column="toTime" property="toTime" />
		<result column="address" property="address" />
		<result column="detail" property="detail" />
		<result column="expenseExplanation" property="expenseExplanation" />
		<result column="refundExplanation" property="refundExplanation" />
		<result column="notice" property="notice" />
		<result column="clickCount" property="clickCount" />
		<result column="likeCount" property="likeCount" />
		<result column="shareCount" property="shareCount" />
		<result column="remark" property="remark" />
		<result column="releaseTime" property="releaseTime" />
		<result column="createTime" property="createTime" />
		<result column="updateTime" property="updateTime" />
		<collection property="activityPackages" ofType="com.newgen.bean.ActivityPackage">
			<result column="ap_id" property="id" />
			<result column="ap_activityId" property="activityId" />
			<result column="ap_price" property="price" />
			<result column="ap_quota" property="quota" />
			<result column="ap_title" property="title" />
			<result column="ap_explanation" property="explanation" />
			<result column="ap_createTime" property="createTime" />
			<result column="ap_updateTime" property="updateTime" />
		</collection>
		<collection property="activitySignUps" ofType="java.util.Map">
			<result column="asu_id" property="id" />
			<result column="asu_name" property="name" />
			<result column="asu_phone" property="phone" />
		</collection>
		<collection property="activityMemberLikes" ofType="java.util.Map">
			<result column="aml_id" property="id" />
			<result column="aml_phone" property="phone" />
			<result column="aml_photo" property="logoPath" />
		</collection>
	</resultMap>
	
	<resultMap id="mapBaseResult" type="com.newgen.bean.Activity" >
		<result column="id" property="id" />
		<result column="status" property="status" />
		<result column="title" property="title" />
		<result column="summary" property="summary" />
		<result column="sponsorId" property="sponsorId" />
		<result column="asp_sponsor" property="sponsor" />
		<result column="asp_logoPath" property="logoPath" />
		<result column="homePath" property="homePath" />
		<result column="serialNumber" property="serialNumber" />
		<result column="editor" property="editor" />
		<result column="fromTime" property="fromTime" />
		<result column="toTime" property="toTime" />
		<result column="address" property="address" />
		<result column="detail" property="detail" />
		<result column="expenseExplanation" property="expenseExplanation" />
		<result column="refundExplanation" property="refundExplanation" />
		<result column="notice" property="notice" />
		<result column="clickCount" property="clickCount" />
		<result column="likeCount" property="likeCount" />
		<result column="shareCount" property="shareCount" />
		<result column="remark" property="remark" />
		<result column="releaseTime" property="releaseTime" />
		<result column="createTime" property="createTime" />
		<result column="updateTime" property="updateTime" />
		<collection property="activityPackages" ofType="com.newgen.bean.ActivityPackage">
			<result column="ap_id" property="id" />
			<result column="ap_activityId" property="activityId" />
			<result column="ap_price" property="price" />
			<result column="ap_quota" property="quota" />
			<result column="ap_title" property="title" />
			<result column="ap_explanation" property="explanation" />
			<result column="ap_createTime" property="createTime" />
			<result column="ap_updateTime" property="updateTime" />
		</collection>
		<collection property="activitySignUps" ofType="java.util.Map">
			<result column="asu_id" property="id" />
			<result column="asu_name" property="name" />
			<result column="asu_phone" property="phone" />
		</collection>
		<collection property="activityMemberLikes" ofType="java.util.Map">
			<result column="aml_id" property="id" />
			<result column="aml_phone" property="phone" />
			<result column="aml_photo" property="logoPath" />
		</collection>
	</resultMap>
	
	<!-- sys_user table all fields -->
	<sql id="Base_Column_List" >
		id, status, title, summary, sponsorId, homePath, serialNumber, editor, FromTime, ToTime, address, detail, 
		expenseExplanation, refundExplanation, notice, clickCount, likeCount, shareCount, remark, 
		releaseTime, createTime, updateTime
	</sql>
	
	<!-- 插入记录 -->
	<insert id="add" parameterType="Object" >
		insert into t_activity(title, summary, sponsorId, homePath, serialNumber, editor,
							FromTime, ToTime, address, detail, expenseExplanation, refundExplanation,
							notice, remark, createTime, updateTime
		)
		values(#{title}, #{summary}, #{sponsorId}, #{homePath}, #{serialNumber}, #{editor}, 
			#{FromTime}, #{ToTime}, #{address}, #{detail}, #{expenseExplanation}, #{refundExplanation}, 
			#{notice}, #{remark}, #{createTime}, #{updateTime})
	</insert>
	
	<select id="findList" parameterType="Object" resultType="java.util.Map">
		select 
			a.id, 
			a.status, 
			a.title, 
			a.summary, 
			asp.name AS sponsor, 
			asp.logoPath AS logoPath, 
			IFNULL(a.homePath, '') AS homePath, 
			case when COUNT(asp.id) &gt; 1 then CONCAT('¥', MIN(ap.price), '起') else if(ap.price = 0, '免费', CONCAT('¥', ap.price)) end AS price, 
			a.serialNumber, 
			a.clickCount, 
			a.address
		from t_activity a
		inner join t_activity_sponsor asp on asp.id = a.sponsorId
		inner join t_activity_package ap on ap.activityId = a.id
		group by a.id
		order by a.releaseTime desc
		<if test="index != null and row != null">
			limit ${index}, ${row}
		</if>
	</select>
	
	<select id="queryById" parameterType="java.lang.Long" resultMap="mapBaseResult">
		select 
			a.*, 
			asp.name asp_sponsor,
			asp.logoPath asp_logoPath,
			ap.id ap_id,
			ap.activityId ap_activityId,
			ap.price ap_price,
			ap.quota ap_quota,
			ap.title ap_title,
			ap.explanation ap_explanation,
			ap.createTime ap_createTime,
			ap.updateTime ap_updateTime,
			asu.id AS asu_id,
			asu.name AS asu_name,
			asu.phone AS asu_phone,
			aml.id AS aml_id,
			aml.phone AS aml_phone,
			m.photo AS aml_photo
		from t_activity a
		inner join t_activity_sponsor asp on asp.id = a.sponsorId
		inner join t_activity_package ap on ap.activityId = a.id
		left join t_activity_sign_up asu on asu.activityId = a.id
		left join t_activity_member_like aml on aml.activityId = a.id
		left join t_member m on m.phonenumber = aml.phone
		<where>
		<if test="value != null and value > 0">
			and a.id = #{value}
		</if>
		</where>
	</select>

	<!-- 根据id，修改记录-->  
	<update id="update" parameterType="Object">
		update t_activity set title = #{title}, summary = #{summary}, homePath = #{homePath}, editor = #{editor},
		fromTime = #{fromTime}, toTime = #{toTime}, address = #{address}, detail = #{detail}, 
		expenseExplanation = #{expenseExplanation}, refundExplanation = #{refundExplanation}, 
		notice = #{notice}, remark = #{remark}, updateTime = #{updateTime}
		where id = #{id}
	</update>

</mapper>